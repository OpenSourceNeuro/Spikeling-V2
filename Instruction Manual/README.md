<p align="left"><img width="270" height="170" src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/SpikyLogo.png">

<h1 align="center"> Instruction Manual</h1></p>

<h2 align="left"> Overview</h1></p>

<p style='text-align: justify;'>

This document contains detailed instructions to connect, install and use Spikeling v2.2

The hardware itself is controlled by a <a href="https://www.espressif.com/en/products/devkits/esp32-devkitc">ESP-32 development board</a> (ESP-32 WROVER-E). It runs on a C++ code which can be updated through the <a href="https://www.arduino.cc">Arduino IDE</a>. The <a href="https://github.com/OpenSourceNeuro/Spikeling-V2/tree/main/Arduino%20Code">Arduino Code session</a> in this repository details how to modify the Spikeling code.


<strong>In order to communicate with the ESP-32 micro-controller, users must first install the latest SiLabs <a href="https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers">CP210x driver</a></strong>

The software itself consists on a Graphical User Interface (GUI) built on python using the pyqt6/pyside6 library packages:
  - Users can run the <a href="https://github.com/OpenSourceNeuro/Spikeling-V2/tree/main/GUI/PyQt">python code</a> directly by executing the <strong>Main.py</strong> file.
  - A Windows executable file is also available and can be found <a href="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/GUI/Windows/Spikeling.exe">here</a>
  - A Linux version is available <a href="">here</a>
  - And a Mac version <a href="">here</a>

  </p>

  ***

<h2 align="left">Spikeling GUI</h2></p>

<p style='text-align: justify;'>

Once the CP210x has been installed, users can launch the Spikeling software.

On the home page, menus can be found on the left tab

</p>

<br></br>

<img align="left"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Spikeling_Menu.png" width="176" height="54">
<h4 align="left"> Spikeling Menu</h4>

<p style='text-align: justify;'>
In the Spikeling tab, users need to select <strong> Neuron Interface </strong> in order to display the main oscilloscope screen on which all traces will be displayed

<br></br>

<img align="center"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Oscilloscope.png" width="1080" height="593">

<p style='text-align: justify;'>
To connect the Spikeling device with the GUI, <strong>select a COM port</strong>. If several are available, the correct COM port should make the device's LEDs light up in sequence. Then click <strong> Connected</strong>

<p style='text-align: justify;'>
From now on, the oscilloscope should display three traces. by default, the Spikeling Vm, the total input current it is receiving, and the stimulus output. Traces can be selected or unselected from the oscilloscope, to only the ones of interest.

<p style='text-align: justify;'>
The first three traces concern the Spikeling device to which the computer is connected. the next two concern a second Spikeling unit connected to the main one through the <strong> Synapse in 1</strong> plug. The last two concern a third unit connected to the <strong> Synapse in 2</strong> plug.

<p style='text-align: justify;'>
On the top right corner, two buttons can be found <strong> LED On</strong> and <strong> Buzzer On</strong>, which can respectively silence the device LED and buzzer.

<p style='text-align: justify;'>
Neuron modes can be manually selected on the board by pushing the button on the bottom right corner of the spikeling device. Or it could be directly selected from the software by selecting one of the twelve default modes. Note that for this neuron mode change to be efficient, one need to click on the <strong> Apply</strong> button.

<p style='text-align: justify;'>
Furthermore, unique neuronal modes can be generated by the users on the <strong>Neuron Generator</strong> tab (see below). Such neuron modes can be selected by clicking in the <strong>Browse</strong> button, then activating it by clicking on <strong> Apply</strong>

<br></br>

On the right hand side of the screen is the parameter tab:

- <strong><ins>Neuron Parameters:</ins></strong>

    <p style='text-align: justify;'>
    Here users can manipulate most variables related to the neuron behaviour. These are a redundancy from the knobs on the spikeling device. When toggle buttons are enabled, the software take over the know and a digital value is displayed, allowing users an accurate and reliable settings of the spikeling neuron.

    - <ins>Injected Current:</ins>

      <img align="right"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Neuron_Parameters.png" width="204" height="676">

      <p style='text-align: justify;'>
      This parameter correspond to the amount of current (0 by default) injected into the neuron. It stimulates how an electrophysiology rig would perform a patch clamp experiment by holding the neuron current. Across the spikeling project, current are technically arbitrary units but can be explained to students as corresponding to mA.

      On the board, this corresponds to the bottom left knob

    - <ins>Noise:</ins>

      <p style='text-align: justify;'>
      No recording is noise free, unfortunately. This specific variable adds a random noise at different intensities in order to mimic noise from the environment, from the recording station, even the thermal noise from the neuronal tissue itself. This functions aims to educate students to appreciate how background noise affects recording and hides real spiking events. In advanced classes, this functions can be used to test the efficiency of a spike sorting algorithm.

      On the board, this corresponds to the bottom right knob

    - <ins>Synaptic Gain:</ins>

      <p style='text-align: justify;'>
      The synaptic gain corresponds to the polarity and strength of the synapse. Elicited spikes on the auxiliary spikeling devices trigger synaptic events on the main one. Such events can be enhanced, either positively (excitatory synapse) or negatively (inhibitory synapse). The resulting event is then integrated as an input current by the main spikeling device.

      <p style='text-align: justify;'>
      The strength of these synapses can be interpreted to students as the amount of vesicles released or even, the number of neurotransmitter receptors on the post synaptic membrane. The polarity of the synapse can be interpreted as the type of neurotransmitter released (i.e. Glutamate/GABA)

      On the board, these correspond to the knobs on the left

    - <ins> Synaptic Decay: </ins>

      <p style='text-align: justify;'>
      This variable is not present on the device and can only be manipulated on the GUI. It corresponds to the synapse dynamics, more explicitly, the rate at which a synaptic current will dissipate. It could be interpreted to students for example as the rate at which the neurotransmitter reuptake from the synaptic cleft occurs.

      <br>  </br>

- <strong><ins>Stimulus Parameters:</strong></ins>

  <p style='text-align: justify;'>
  This tab only concerns stimulation variables. On the spikeling device, the default stimulus consists of a square wave that is generated on the <strong>Stimulus Output</strong> plug at the bottom right of the board. Users on the board can modify the stimulus strength and frequency.

  <p style='text-align: justify;'>
  If the user want to directly stimulate the spikeling neuron (or an auxiliary unit connected via a synaptic input), a jack needs to be plugged from the <strong>Stimulus Output</strong> plug where it is generated, to the <strong> Current Input</strong> plug which can be interpreted to students as the experimental current applied to a neuron through a patching pipette during a classic electrophysiology experiment. Users can note that the diagram on top of the Spikeling board, represents such pipette.

  <p style='text-align: justify;'>
  Users can alternatively choose to plus the <strong>Stimulus Output</strong> plug to a jack-LED cord. The generated stimulus will then light up the LED which the user can then place on top of the represented <strong>Photoreceptor</strong> at the bottom of the board. It will be noted here that the light falls onto a photoreceptor outer segment, itself synapsing with the main neuron. The stimulation then becomes indirect via a photoactivation process.

  - <ins>Stimulus Frequency:</ins>

    <img align="right"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Stimulus_Parameters.png" width="205" height="677">

   <p style='text-align: justify;'>
   As above, once a parameter is enabled, it takes over the value encoded by the know on the board.
   Here, this variable modulates the square wave stimulus frequency, from 10 to 1000Hz (related to the "Spikeling time", obviously slowed down here on the oscilloscope)

   On the board, it corresponds to the knob on the right, at the top

  - <ins>Stimulus Strength:</ins>

   <p style='text-align: justify;'>
   This variable is in arbitrary unit and corresponds to the strength and polarity of the square wave stimulus.

   On the board, it corresponds to the knob on the right, at the bottom.

  - <ins>Custom Stimulus:</ins>

   <p style='text-align: justify;'>
   Square wave stimuli are very handy to manipulate but can prove limited if not boring for advanced classes. Spikeling then comes with a stimulus generator (see below), where users can generate their own stimulation protocol.

   <p style='text-align: justify;'>
   Stimulus first need to be selected, by clicking on the <strong>Load</strong> button. A display of the stimulus will then appear on the little oscilloscope below. Stimulation will only be effective when the toggle button will be enabled.

  - <ins>Photo-Receptor - Photo-Gain:</strong>

   <p style='text-align: justify;'>
   This variable deals with the sensitivity and polarity of the photoreceptor. Units are arbitrary. It can be interpreted as variation amongst cell types, i.e. type of post-synaptic neurotransmitter receptors (ionotropic/metabotropic) to justify the polarity.

   On the board, it corresponds to the knob on the bottom, in the middle.

  - <ins>Photo-Receptor - Photo-Decay:</strong>

   <p style='text-align: justify;'>
   This variable is only accessible on the GUI and corresponds to the rate at which the photo current generated by the photoreceptor will dissipate.

  - <ins>Photo-Receptor - Photo-Recovery:</strong>

   <p style='text-align: justify;'>
   This variable is only accessible on the GUI and corresponds to the rate at which the current generated by the photoreceptor desaturates.

   By modulating the two variable above, users can modify the photoreceptor dynamics and generated different current input (i.e transient/sustained) that will in turn elicit different trains of spikes.


   <br></br>

   <p style='text-align: justify;'>
   Finally, the neuron interface comes with a recording system. Users needs to select a repository where to save their data, enter a file name (careful, similar filename will overwrite previous version).

   <p style='text-align: justify;'>
   Then by hitting the <strong>Record</strong> button, the current traces will be save in a .csv format.
   Recording will cease only when users would click on the <strong> Stop</strong> button.


<br></br>

<p style='text-align: justify;'>
Recorded data can be analysed on the go within the Spikeling tab menu, by selecting <strong>Data Analysis</strong>.
At the moment, only square wave data can be analysed here. Future updates will integrate more advanced data analysis. However jupyter-notebooks are available to analyse the data or users can just use the .csv file generated and analysed it on their programming language of choice. Currently a R version is being developed to be coupled with on going data analysis courses

<p style='text-align: justify;'>
First <strong>Load Data</strong> then follow the procedure. Only one variable is left here to the students, the threshold at which one can estimate a spike occurs. Different values might end up in quite different average traces.

At each step, users can displayed traces from other neurons if any were connected.


<br></br>

<img align="left"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Imaging_Menu.png" width="175" height="53">
<h4 align="left"> Imaging Menu</h4>

<p style='text-align: justify;'>
Spikeling receives many inputs but generates only one data, the neuron voltage membrane potential (Vm). Following diverse interactions, this Vm might cross a pre-defined threshold (-30mV) and elicit a spike. Since such spikes are identified and used by the device for various operations, they can also be used to feed a calcium model that would mimic the transient rise of calcium concentration within a neuron following a spike.
From then a second model could use such calcium transient trace to model a fluorescence trace as it could be observed under a two-photon microscope for example.

<p style='text-align: justify;'>
So let's now consider spikeling neuron as being a one pixel fluorescent object. By clicking on the <strong>Imaging Stimulation</strong> button, an oscilloscope displaying this one pixel fluorescence trace will pop up (Up tp three one pixel neuron fluorescence traces if users select the <strong> Multiple Imaging</strong> button).

<p style='text-align: justify;'>
By default, only the fluorescence trace is enabled, which is the data on which students should work on as it represents the data they will be faced with during a dynamic fluorescence recording experiment. But users can also display the Calcium trace that is used to generate the fluorescence one, as well as the Vm that we can consider here as the ground truth data.

On these sections, three parameter tabs can be explore, each considering a specific variable group:

- <strong><ins>Imaging Parameters</ins></strong>

  In this section, users can manipulate variable dependent of the experimental recording system itself.

  - <ins> Calcium Indicator:</ins>

    <img align="right"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Imaging_Parameters.png" width="203" height="674">

    <p style='text-align: justify;'>
    This section is a work in progress, but ultimately users could choose distinct calcium indicator models with different dynamics and kinetics properties. These are summed up in three variables (described on the calcium model equations): the indicator affinity to calcium, its dissociation constant and its brightness. These values are displayed on the parameter tab.

  - <ins> Imaging frame rate:</ins>

    <p style='text-align: justify;'>
    This variables correspond to the sampling rate for the fluorescence trace. The aim here is to let student appreciate, despite the fact that they are scanning a one pixel object, that they is an important trade off between the imaging rate and the necessity for a better scanning resolution. Point is that lower frame rate will miss some fluorescence event underlying spiking events.

  - <ins> Photo-detection gain:</strong>

    <p style='text-align: justify;'>
    This variable increases the fluorescence traces signal but incorporate some random noise as it goes into higher intensity. It can be interpreted as the PMT gain from a recording system.

  - <ins> Laser power:</ins>

    <p style='text-align: justify;'>
    This variable is similar to the previous one as it enhances the fluorescence signal, but integrates a decay counter that diminishes this effect overtime in a non reversible way, in order to simulate a photo-bleaching effect.

  <p style='text-align: justify;'>
  The two variables above must be manipulated together in order for students to appreciate the fine tuning of a recording setup in order to get a proper signal to noise ration while avoiding noise artefacts.

<br></br>

- <strong><ins>Calcium Parameters:</ins></strong>

  In this section users can manipulate calcium intrinsic properties of the neuron itself.
  In this Calcium model, we assume a single-compartmental, equipotential model of the imaged neuron, over which the fluorescence signal may be spatially averaged, yielding a one-dimensional time varying fluorescence signal for each image from (<a href="https://www.cell.com/fulltext/S0006-3495%2809%2900311-7">Vogelstein et al. 2009</a>)

```math
[Ca^{2+}]_{t} = [Ca^{2+}]_{t-1} - \tau . [Ca^{2+}]_{t-1} + [Ca^{2+}]_{b} + A . n_{t} + \sigma_{Ca} . \sqrt{\Delta} . \varepsilon_{Ca,t}
```

  <img align="right"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Calcium_Parameters.png" width="202" height="676">

  Where:
  - $\tau$ is the Calcium decay constant
  - $[Ca^{2+}]_{b}$ the Calcium baseline concentration
  - A is the calcium concentration jump each spike triggers
  - $n_{t}$ is the number of spikes at time t
  - $\sigma_{Ca}$ scales the Calcium noise
  - $\Delta$ represents the imaging frame timeline
  - $\varepsilon_{Ca,t}$ is a standard normal Gaussian noise source

<br></br>

  - <ins>Calcium decay:</ins>

    <p style='text-align: justify;'>
    This corresponds to the rate at which a calcium event returns exponentially to its baseline concentration value with a time constant $\tau$ . This can be interpreted at the myriad of calcium extrusion and endogenous buffering mechanism and we sum it up into this single average time constant.

    $\tau  .  [Ca^{2+}]_{t-1}$

  - <ins>Calcium jump per spike:</ins>

    <p style='text-align: justify;'>
    This corresponds to the calcium concentration rise that follows each spike event. We assume here that each jump is of the same size. In this specific model we neglect the calcium concentration saturation effects due to channel inactivation and buffering (next model will consider them).

    $A . n_{t}$

  - <ins>Calcium noise scale:</ins>

    <p style='text-align: justify;'>
    Calcium concentration dynamics themselves have some Gaussian noise source, scaled by $\sigma_{Ca}$

    $\sigma_{Ca}$ . $\sqrt{\Delta}$ . $\varepsilon_{Ca,t}$

  - <ins> Calcium baseline:</ins>

    <p style='text-align: justify;'>
    This corresponds to the intrinsic intracellular concentration of calcium within the neuron at rest.

    $[Ca^{2+}]_{b}$

<br></br>

 - <strong><ins>Fluorescence Parameters</ins></strong>

 Finally this section deals with variables associated with the fluorescence itself.

  - <ins>Fluorescence scale</ins>

  <img align="right"  src="https://github.com/OpenSourceNeuro/Spikeling-V2/blob/main/Images/Fluorescence_Parameters.png" width="202" height="674">
